!function(){"use strict";var t=!("undefined"!=typeof module&&module.exports),e=t?window.pathy:require("pathy"),o=function(){function t(t,e,o){this.$parent=t,this.$key=e,this.$schema=o,this.$parent.$view.watch(this.$key,m(this._didChange,this)),this._didChange()}function o(t){return this instanceof o?void(this.type=t):new o(t)}function i(t,e){this.$schema=t,this.$view=e}function n(t,e){this.paths=t,this.options=e||{},this.members=this.options.members||{},delete this.options.members,this.members.init&&(this.initializer=this.members.init,delete this.members.init)}function r(t){return this instanceof r?void(this.paths=t):new r(t)}function s(){return this instanceof s?(this.objectFactory=r,this.collectionFactory=o,this.valueFactory=h,this.pathFactory=a,this.typeMatchers=[],void this.typeMatchers.push(function(t){return t instanceof r})):new s}function a(t,o){return this instanceof a?(this.name=t,this.type=o,void(this.accessor=e(t))):new a(t,o)}function c(t){this.cast=t}function u(t,e){this.name="ValidationError",this.message=t,this.error=e||null}function p(t){return t}function h(t,e){return this instanceof h?(this.type="function"==typeof t?new c(t):t,this.options=e||{},this.validators=[],void this.validators.push(function(t){if(null===t||void 0===t){if(this.options.optional)return!0;throw new u("Value cannot be null.")}})):new h(t,e)}function f(t){this.view=t,this._local={},this.reset()}function y(t){function e(e){return"object"==typeof e&&null!==e?"array"===d(t)?i(array):o(e):e}function o(t){return Object.keys(t).map(function(o){return{key:o,value:e(t[o])}}).reduce(function(t,e){return t[e.key]=e.value,t},{})}function i(t){return t.map(function(t){return e(t)})}return e(t)}function l(t,e){function o(t,e){for(var o=Object.keys(e),n=0,r=o.length;r>n;n++)i(t,o[n],e[o[n]])}function i(t,e,i){var r=t[e];if(void 0!==i)return"object"==typeof r&&null!==r&&"object"==typeof i&&null!==i?void n.push({dest:r,src:i,merge:o}):void(t[e]=i)}if(!t||"object"!=typeof t)return t;for(var n=[],r=Array.prototype.slice.call(arguments,1),s=0,a=r.length;a>s;s++)r[s]&&"object"==typeof r[s]&&n.push({dest:t,src:r[s],merge:o});for(;n.length>0;){var c=n.pop();c.merge(c.dest,c.src)}return t}function d(t){return Object.prototype.toString.call(t).match(/^\[object\s(.*)\]$/)[1].toLowerCase()}function v(t,e){for(var o=0,i=t.length;i>o;o++)if(e(t[o]))return o;return-1}function m(t,e){var o=Array.prototype.slice.call(arguments,2);return function(){return t.apply(e,o.concat(Array.prototype.slice.call(arguments)))}}var w={},g=new s,b=new s;return b.typeMatchers.push(function(t){return t instanceof n}),w.Type=function(t){return g.parse(t)},w.Schema=function(t,e){return new n(b.parse(t).paths,e)},w.Collection=t,t.prototype=Object.create(Array.prototype),t.prototype.constructor=t,t.prototype.add=function(t){return-1===this.indexOf(t)&&(this.remove(t),t=this.$schema.cast(t),this.push(t),this._apply()),t},t.prototype.remove=function(t){var e=this.indexOf(t);-1===e&&(e=v(this,function(e){return e.equals(t)})),e>-1&&(this.splice(e,1),this._apply())},t.prototype["new"]=function(t){return this.$schema["new"](t)},t.prototype.addNew=function(t){return this.add(this["new"](t))},t.prototype.clear=function(){this.length=0,this._apply()},t.prototype.toJSON=function(){return this.map(function(t){return t.toJSON()})},t.prototype._didChange=function(){var t=this;this._updating||(this.length=0,(this.$parent.$view.get(this.$key)||[]).forEach(function(e){t.push(t.$schema.cast(e))}))},t.prototype._apply=function(){this._updating=!0,this.$parent.$view.set(this.$key,this.map(function(t){return t.$view})),this._updating=!1},w.CollectionSchema=o,o.prototype.cast=function(t){if(void 0===t&&(t=null),"array"===d(t)){var e=this.type;return t.map(function(t){return e.cast(t)})}return[]},o.prototype.validate=function(t){if("array"!==d(t))throw new u("Value must be an array.");var e=this.type;t.forEach(function(t,o){try{e.validate(t)}catch(i){throw new u("The item at index "+o+" is invalid.",i)}})},w.Model=i,i.prototype.edit=function(){return this.$schema.cast(this.$view.fork())},i.prototype.commit=function(){this.$view.commit()},i.prototype.reset=function(){this.$view.reset()},i.prototype.toJSON=function(){return this.$view.toJSON()},i.prototype.equals=function(t){return t===this},w.ModelSchema=n,n.prototype["new"]=function(t){return this.cast(y(t||{}))},n.prototype.cast=function(t){if(void 0===t||null===t)return null;var e;if(t instanceof i){if(t.$schema===this)return t;e=t.$view}else t instanceof f?e=t:(t.toJSON&&(t=t.toJSON()),e=new f,e.merge(t));var o=new i(this,e);return this.addPaths(o),this.addMembers(o),this.initializer&&this.initializer.call(o),o},n.prototype.addPaths=function(t){var e=this;this.paths.forEach(function(i){i.type.type instanceof o&&i.type.type.type.type instanceof n?e.addCollectionPath(t,i):e.addAttributePath(t,i)})},n.prototype.addCollectionPath=function(o,i){var n=new t(o,i.name,i.type.type.type.type);e(i.name).override(o,{get:function(){return n}})},n.prototype.addAttributePath=function(t,o){e(o.name).override(t,{initialize:!1,get:function(){return o.type.cast(t.$view.get(o.name))},set:function(e){t.$view.set(o.name,o.type.cast(e))}})},n.prototype.addMembers=function(t){var e=this;Object.keys(this.members).forEach(function(o){var i=e.members[o];"function"==typeof i?e.addFunctionMember(t,i,o):i&&"object"==typeof i&&e.addPropertyMember(t,i,o)})},n.prototype.addFunctionMember=function(t,o,i){o=m(o,t),e(i).override(t,{get:function(){return o}})},n.prototype.addPropertyMember=function(t,o,i){var n={};"function"==typeof o.get&&(n.get=m(o.get,t)),"function"==typeof o.set&&(n.set=m(o.set,t)),Object.keys(n).length>0&&(n.initialize=!1,e(i).override(t,n))},w.ObjectSchema=r,r.prototype.cast=function(t){return void 0===t&&(t=null),this.paths.reduce(function(e,o){return o.set(e,o.type.cast(o.get(t))),e},{})},r.prototype.validate=function(t){this.paths.forEach(function(e){try{e.type.validate(e.get(t))}catch(o){throw new u("The value at "+e.name+" is invalid.")}})},w.SchemaParser=s,s.prototype.parse=function(t){return this.isValueNode(t)?this.valueFromNode(t):this.objectFactory(this.pathsFromNode("",t))},s.prototype.pathsFromNode=function(t,e){if(void 0===e)return[];if(this.isValueNode(e))return[this.pathFactory(t,this.valueFromNode(e))];var o=this;return Object.keys(e).map(function(i){return o.pathsFromNode(t?t+"."+i:i,e[i])}).reduce(function(t,e){return t.concat(e)},[])},s.prototype.isTypeNode=function(t){var e="function"==typeof t||"array"===d(t);if(!e)for(var o=0,i=this.typeMatchers.length;i>o&&!e;o++)e=this.typeMatchers[o](t);return e},s.prototype.isTypeNodeWithOptions=function(t){return"object"==typeof t&&null!==t&&this.isTypeNode(t.type)},s.prototype.optionsFromNode=function(t){var e=y(t);return delete e.type,e},s.prototype.typeFromNode=function(t){return this.isCollectionType(t)?this.collectionFromNode(t):t},s.prototype.isCollectionType=function(t){return t===Array||"array"===d(t)},s.prototype.isValueNode=function(t){return this.isTypeNode(t)||this.isTypeNodeWithOptions(t)},s.prototype.valueFromNode=function(t){return this.isTypeNodeWithOptions(t)?this.valueFactory(this.typeFromNode(t.type),this.optionsFromNode(t)):this.valueFactory(this.typeFromNode(t))},s.prototype.collectionFromNode=function(t){return this.collectionFactory("array"===d(t)&&t.length>0?this.valueFromNode(t[0]):this.valueFactory(p))},w.SchemaPath=a,a.prototype.get=function(t){return this.accessor.get(t)},a.prototype.set=function(t,e){this.accessor.set(t,e)},c.prototype.validate=function(){},w.ValidationError=u,u.prototype=Object.create(Error.prototype),u.prototype.constructor=u,w.ValueSchema=h,w.Any=p,h.prototype.cast=function(t){return void 0===t&&(t=null),this.options.optional&&null===t?null:this.type.cast(t)},h.prototype.validate=function(t){for(var e=0,o=this.validators.length;o>e;e++)if(this.validators[e].call(this,t)===!0)return;this.type.validate(t)},w.View=f,f.prototype.get=function(t){var o=e(t).get(this._local.value);return void 0===o&&this.view?this.view.get(t):o},f.prototype.set=function(t,o){e(t).set(this._local.value,o)},f.prototype.reset=function(){this._local.value={}},f.prototype.merge=function(t){l(this._local.value,t)},f.prototype.commit=function(){if(!this.view)throw new Error("No subview to commit to!");this.view.merge(this._local.value),this.reset()},f.prototype.toJSON=function(){return l(y(this._local.value),this.view&&this.view.toJSON()||{})},f.prototype.fork=function(){return new f(this)},f.prototype.watch=function(t,o){this.view&&this.view.watch(t,o),e(t).watch(this._local.value,o)},w.util={cloneDeep:y,merge:l},w}();t?("function"==typeof define&&define.amd&&define(function(){return o}),window.model=o):module.exports=o}();